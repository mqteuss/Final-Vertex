<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extrator Avançado de FIIs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .loader { border-top-color: #6366f1; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        pre::-webkit-scrollbar { width: 8px; height: 8px; }
        pre::-webkit-scrollbar-track { background: #1e293b; border-radius: 4px; }
        pre::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="min-h-screen bg-slate-100 p-4 md:p-8 text-slate-800 font-sans pb-24">

    <div class="max-w-5xl mx-auto space-y-6">
        
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="bg-indigo-100 p-3 rounded-xl">
                    <i data-lucide="layers" class="text-indigo-600 w-8 h-8"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-900">Extrator Avançado de FIIs</h1>
                    <div class="text-sm text-slate-500 mt-1 flex items-center gap-3">
                        <p>Extraia e visualize os dados do StatusInvest.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-4">
            <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider flex items-center gap-2 mb-4">
                <i data-lucide="settings" class="w-4 h-4"></i> Parâmetros da Consulta
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Código (Ticker)</label>
                    <div class="relative">
                        <input type="text" id="ticker" value="GARE11" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none uppercase font-mono pr-10">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Categoria</label>
                    <select id="assetType" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none font-medium text-indigo-700 bg-indigo-50 transition-colors">
                        <option value="fii">FIIs</option>
                        <option value="fiagro">Fiagros</option>
                        <option value="acoes">Ações</option>
                        <option value="bdrs">BDRs</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Ponto de Acesso</label>
                    <select id="endpoint" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Estrutura (Type)</label>
                    <select id="dataType" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 disabled:bg-slate-100 disabled:text-slate-400">
                        <option value="0">Tipo 0 (Padrão)</option>
                        <option value="1">Tipo 1 (Alternativo)</option>
                        <option value="2">Tipo 2 (Máximo)</option>
                    </select>
                </div>
            </div>
            
            <div id="rangeOptions" class="hidden grid-cols-2 gap-4 mt-4 p-4 bg-slate-50 rounded-xl border border-slate-200">
                <div>
                    <label class="block text-xs font-medium text-slate-600 mb-1">Ano Inicial</label>
                    <input type="number" id="rangeMin" value="2020" class="w-full px-3 py-1.5 border border-slate-300 rounded-md text-sm">
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-600 mb-1">Ano Final</label>
                    <input type="number" id="rangeMax" class="w-full px-3 py-1.5 border border-slate-300 rounded-md text-sm">
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <button id="btnExtractProxy" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-semibold py-3 px-6 rounded-xl transition-all disabled:opacity-50 flex justify-center items-center gap-2 shadow-sm cursor-pointer">
                <i data-lucide="download" class="w-5 h-5"></i> Extrair e Visualizar Dados
            </button>
            <div id="errorMsg" class="hidden mt-4 bg-red-50 text-red-700 p-4 rounded-xl text-sm border border-red-200"></div>
        </div>

        <div id="dataContainer" class="hidden bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
            <div class="flex bg-slate-50 border-b border-slate-200">
                <button id="tabChart" class="flex-1 py-3 font-medium text-sm flex justify-center items-center gap-2 bg-white text-indigo-700 border-b-2 border-indigo-600">
                    <i data-lucide="bar-chart-2" class="w-4 h-4"></i> Gráfico
                </button>
                <button id="tabTable" class="flex-1 py-3 font-medium text-sm flex justify-center items-center gap-2 text-slate-600 hover:bg-slate-100">
                    <i data-lucide="list" class="w-4 h-4"></i> Tabela
                </button>
                <button id="tabJson" class="flex-1 py-3 font-medium text-sm flex justify-center items-center gap-2 text-slate-600 hover:bg-slate-100">
                    <i data-lucide="file-json" class="w-4 h-4"></i> JSON Bruto
                </button>
            </div>

            <div id="viewChart" class="p-6">
                <canvas id="myChart" style="max-height: 400px;"></canvas>
            </div>

            <div id="viewTable" class="hidden p-0 overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-500">
                    <thead id="tableHead" class="text-xs text-slate-700 uppercase bg-slate-50 border-b border-slate-200">
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>

            <div id="viewJson" class="hidden bg-slate-900 p-0 relative">
                <button id="btnCopyJson" class="absolute top-4 right-4 text-xs flex items-center gap-1 bg-white/10 text-white border border-white/20 px-3 py-1.5 rounded-lg hover:bg-white/20 transition-colors">
                    <i data-lucide="copy" class="w-3 h-3"></i> Copiar
                </button>
                <pre id="jsonBlock" class="text-green-400 p-6 overflow-auto text-xs max-h-[500px] font-mono"></pre>
            </div>
        </div>

    </div>

    <script>
        lucide.createIcons();
        let chartInstance = null;

        const state = {
            assetType: 'fii', ticker: 'GARE11', endpoint: 'getpatrimonioliquido',
            dataType: '0', rangeMin: '2020', rangeMax: new Date().getFullYear().toString(),
            activeDataTab: 'chart', proxyData: null
        };

        const endpoints = [
            { id: 'getpatrimonioliquido', name: 'Património Líquido', param: 'code' },
            { id: 'getreceitas', name: 'Receitas', param: 'code' },
            { id: 'getdespesas', name: 'Despesas', param: 'code' },
            { id: 'getcaixa', name: 'Caixa', param: 'code' },
            { id: 'getresultado', name: 'Resultado', param: 'code' },
            { id: 'demonstracoestrimestrais', name: 'Demonstrações Trimestrais', param: 'code', requiresRange: true },
            { id: 'companytickerprovents', name: 'Proventos / Dividendos', param: 'companyName', extraParam: '&chartProventsType=1' }
        ];

        // Populando Select
        const endpointSelect = document.getElementById('endpoint');
        endpoints.forEach(ep => {
            const opt = document.createElement('option');
            opt.value = ep.id; opt.textContent = ep.name;
            endpointSelect.appendChild(opt);
        });
        document.getElementById('rangeMax').value = state.rangeMax;

        // Atualização de UI Básica
        const updateUIParams = () => {
            const ep = endpoints.find(e => e.id === state.endpoint);
            document.getElementById('rangeOptions').style.display = ep.requiresRange ? 'flex' : 'none';
            document.getElementById('dataType').disabled = (ep.id === 'companytickerprovents');
        };

        ['ticker', 'assetType', 'endpoint', 'dataType', 'rangeMin', 'rangeMax'].forEach(id => {
            document.getElementById(id).addEventListener('change', (e) => {
                state[id] = e.target.value; updateUIParams();
            });
        });

        // Abas de Visualização
        const setTab = (tabName) => {
            state.activeDataTab = tabName;
            const tabs = ['Chart', 'Table', 'Json'];
            tabs.forEach(t => {
                const isMatch = tabName.toLowerCase() === t.toLowerCase();
                document.getElementById(`view${t}`).classList.toggle('hidden', !isMatch);
                
                const btn = document.getElementById(`tab${t}`);
                if (isMatch) {
                    btn.className = `flex-1 py-3 font-medium text-sm flex justify-center items-center gap-2 bg-white text-indigo-700 border-b-2 border-indigo-600`;
                } else {
                    btn.className = `flex-1 py-3 font-medium text-sm flex justify-center items-center gap-2 text-slate-600 hover:bg-slate-100`;
                }
            });
        };

        document.getElementById('tabChart').addEventListener('click', () => setTab('chart'));
        document.getElementById('tabTable').addEventListener('click', () => setTab('table'));
        document.getElementById('tabJson').addEventListener('click', () => setTab('json'));

        // Extração de Dados
        document.getElementById('btnExtractProxy').addEventListener('click', async () => {
            const btn = document.getElementById('btnExtractProxy');
            const err = document.getElementById('errorMsg');
            const container = document.getElementById('dataContainer');
            
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> A obter dados...`;
            err.classList.add('hidden');
            container.classList.add('hidden');
            lucide.createIcons();

            const ep = endpoints.find(e => e.id === state.endpoint);
            const queryParams = new URLSearchParams();
            queryParams.append(ep.param, state.ticker.toUpperCase());
            if (ep.id !== 'companytickerprovents') queryParams.append('type', state.dataType);
            if (ep.requiresRange) {
                queryParams.append('contabil', 'true');
                queryParams.append('range.min', state.rangeMin);
                queryParams.append('range.max', state.rangeMax);
            }

            const url = `https://statusinvest.com.br/${state.assetType}/${ep.id}?${queryParams.toString()}${ep.extraParam || ''}`;
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;

            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error('Bloqueado');
                const jsonData = await response.json();
                
                state.proxyData = jsonData;
                document.getElementById('jsonBlock').textContent = JSON.stringify(jsonData, null, 2);
                
                processVisualizations(jsonData);
                container.classList.remove('hidden');
            } catch (error) {
                err.textContent = "Erro ao buscar dados. O StatusInvest pode ter bloqueado o pedido ou os parâmetros são inválidos.";
                err.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="download" class="w-5 h-5"></i> Extrair e Visualizar Dados`;
                lucide.createIcons();
            }
        });

        // Função Inteligente para processar JSON para Gráfico/Tabela
        const processVisualizations = (data) => {
            // Tenta encontrar o array de dados (StatusInvest retorna às vezes arrays diretos, ou obj.assetEarningsModels)
            let dataArray = [];
            if (Array.isArray(data)) {
                dataArray = data;
            } else if (data && typeof data === 'object') {
                // Procura a primeira chave que contenha um array (ex: assetEarningsModels)
                const arrayKey = Object.keys(data).find(key => Array.isArray(data[key]));
                if (arrayKey) dataArray = data[arrayKey];
            }

            if (dataArray.length === 0) {
                document.getElementById('viewChart').innerHTML = "<p class='text-slate-500'>Nenhum array de dados suportado encontrado para gerar gráfico.</p>";
                document.getElementById('tableHead').innerHTML = "";
                document.getElementById('tableBody').innerHTML = "<tr><td class='p-4'>Sem dados tabulares.</td></tr>";
                return;
            }

            // --- TABELA ---
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            thead.innerHTML = ''; tbody.innerHTML = '';

            // Pega as chaves do primeiro objeto para criar as colunas
            const keys = Object.keys(dataArray[0]);
            
            const trHead = document.createElement('tr');
            keys.forEach(key => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3';
                th.textContent = key;
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);

            dataArray.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b hover:bg-slate-50';
                keys.forEach(key => {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4';
                    // Formata se for objeto (para não quebrar a tabela)
                    td.textContent = typeof item[key] === 'object' ? JSON.stringify(item[key]) : item[key];
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

            // --- GRÁFICO ---
            // Heurística: Tenta achar uma chave de "data/nome" para o eixo X e uma numéria para o Y
            let xKey = keys.find(k => k.toLowerCase().includes('date') || k.toLowerCase().includes('ed') || k.toLowerCase().includes('competence')) || keys[0];
            let yKey = keys.find(k => k.toLowerCase() === 'value' || k.toLowerCase() === 'v') || keys.find(k => typeof dataArray[0][k] === 'number');

            if (xKey && yKey) {
                const labels = dataArray.map(item => item[xKey]);
                const values = dataArray.map(item => item[yKey]);

                if (chartInstance) chartInstance.destroy(); // Remove gráfico antigo
                
                // Re-cria o canvas para evitar bugs do Chart.js
                document.getElementById('viewChart').innerHTML = '<canvas id="myChart" style="max-height: 400px;"></canvas>';
                const ctx = document.getElementById('myChart').getContext('2d');
                
                chartInstance = new Chart(ctx, {
                    type: 'bar', // ou 'line'
                    data: {
                        labels: labels,
                        datasets: [{
                            label: yKey.toUpperCase(),
                            data: values,
                            backgroundColor: 'rgba(99, 102, 241, 0.2)',
                            borderColor: 'rgba(99, 102, 241, 1)',
                            borderWidth: 2,
                            borderRadius: 4,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true }
                        }
                    }
                });
            } else {
                document.getElementById('viewChart').innerHTML = "<p class='text-slate-500'>Não foi possível identificar eixos X/Y numéricos automaticamente.</p>";
            }
        };

        updateUIParams();
    </script>
</body>
</html>
