<!DOCTYPE html>
<html lang="pt-PT" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extrator Avançado de FIIs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body { font-family: 'Inter', system-ui, sans-serif; }
        
        .card {
            background-color: #18181b;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        
        .glass {
            background: rgba(24, 24, 27, 0.85);
            backdrop-filter: blur(16px);
        }
        
        pre::-webkit-scrollbar { width: 6px; height: 6px; }
        pre::-webkit-scrollbar-track { background: #27272a; }
        pre::-webkit-scrollbar-thumb { background: #52525b; border-radius: 9999px; }
        
        .tab-active {
            background-color: #27272a;
            color: #a5b4fc;
            border-bottom: 3px solid #6366f1;
        }
        
        .data-row:hover {
            background-color: #27272a;
        }
    </style>
</head>
<body class="min-h-screen bg-zinc-950 text-zinc-200 pb-24">

    <div class="max-w-5xl mx-auto px-6 py-10">

        <!-- Header -->
        <div class="flex items-center justify-between mb-12">
            <div class="flex items-center gap-5">
                <div class="w-12 h-12 bg-gradient-to-br from-violet-500 to-indigo-600 rounded-3xl flex items-center justify-center shadow-inner">
                    <i data-lucide="layers" class="w-7 h-7 text-white"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-semibold tracking-tight text-white">Extrator Avançado de FIIs</h1>
                    <p class="text-zinc-500 text-sm">Dados em tempo real • Status Invest</p>
                </div>
            </div>
            <div class="flex items-center gap-2 text-xs uppercase tracking-widest px-4 py-2 bg-zinc-900 rounded-3xl border border-zinc-800">
                <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                ONLINE
            </div>
        </div>

        <!-- Controls -->
        <div class="card rounded-3xl p-8 mb-10 border border-zinc-800/50">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                <!-- Ticker -->
                <div class="md:col-span-3">
                    <label class="block text-xs font-medium text-zinc-500 mb-2 tracking-widest">TICKER</label>
                    <input id="ticker" value="GARE11" 
                           class="w-full bg-zinc-900 border border-zinc-700 focus:border-violet-500 rounded-2xl px-6 py-4 text-2xl font-mono font-semibold outline-none transition-all uppercase">
                </div>
                
                <!-- Categoria -->
                <div class="md:col-span-3">
                    <label class="block text-xs font-medium text-zinc-500 mb-2 tracking-widest">CATEGORIA</label>
                    <select id="assetType" 
                            class="w-full bg-zinc-900 border border-zinc-700 focus:border-violet-500 rounded-2xl px-6 py-4 outline-none text-zinc-200">
                        <option value="fii">FIIs</option>
                        <option value="fiagro">Fiagros</option>
                        <option value="acoes">Ações</option>
                        <option value="bdrs">BDRs</option>
                    </select>
                </div>

                <!-- Indicador -->
                <div class="md:col-span-4">
                    <label class="block text-xs font-medium text-zinc-500 mb-2 tracking-widest">INDICADOR</label>
                    <select id="endpoint" 
                            class="w-full bg-zinc-900 border border-zinc-700 focus:border-violet-500 rounded-2xl px-6 py-4 outline-none text-zinc-200"></select>
                </div>

                <!-- Tipo -->
                <div class="md:col-span-2">
                    <label class="block text-xs font-medium text-zinc-500 mb-2 tracking-widest">TIPO</label>
                    <select id="dataType" 
                            class="w-full bg-zinc-900 border border-zinc-700 focus:border-violet-500 rounded-2xl px-6 py-4 outline-none text-zinc-200">
                        <option value="0">Padrão</option>
                        <option value="1">Alternativo</option>
                        <option value="2">Máximo</option>
                    </select>
                </div>
            </div>

            <!-- Range -->
            <div id="rangeOptions" class="hidden mt-8 grid grid-cols-2 gap-6 pt-8 border-t border-zinc-800">
                <div>
                    <label class="block text-xs font-medium text-zinc-500 mb-2 tracking-widest">ANO INICIAL</label>
                    <input id="rangeMin" type="number" value="2020"
                           class="w-full bg-zinc-900 border border-zinc-700 focus:border-violet-500 rounded-2xl px-6 py-4 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-medium text-zinc-500 mb-2 tracking-widest">ANO FINAL</label>
                    <input id="rangeMax" type="number" value="2025"
                           class="w-full bg-zinc-900 border border-zinc-700 focus:border-violet-500 rounded-2xl px-6 py-4 outline-none">
                </div>
            </div>
        </div>

        <!-- Extract Button -->
        <button id="btnExtract" 
                class="w-full bg-white hover:bg-zinc-100 text-zinc-950 font-semibold py-6 rounded-3xl text-lg flex items-center justify-center gap-3 transition-all shadow-2xl shadow-black/60">
            <i data-lucide="download-cloud" class="w-6 h-6"></i>
            EXTRAIR E VISUALIZAR
        </button>

        <div id="errorMsg" class="hidden mt-6 bg-red-950/70 border border-red-900 text-red-400 p-5 rounded-3xl text-center text-sm"></div>

        <!-- Results -->
        <div id="dataContainer" class="hidden mt-16">
            
            <!-- Tabs -->
            <div class="flex bg-zinc-900 rounded-3xl p-1 mb-8 w-fit">
                <button id="tabChart" class="tab-btn tab-active px-10 py-4 rounded-3xl text-sm font-medium transition-all">GRÁFICO</button>
                <button id="tabTable" class="tab-btn px-10 py-4 rounded-3xl text-sm font-medium text-zinc-400 hover:text-zinc-200 transition-all">TABELA</button>
                <button id="tabJson" class="tab-btn px-10 py-4 rounded-3xl text-sm font-medium text-zinc-400 hover:text-zinc-200 transition-all">JSON BRUTO</button>
            </div>

            <!-- Chart -->
            <div id="viewChart" class="card rounded-3xl p-8 border border-zinc-800/50">
                <canvas id="myChart" class="w-full" height="420"></canvas>
            </div>

            <!-- Table -->
            <div id="viewTable" class="card rounded-3xl overflow-hidden hidden border border-zinc-800/50">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead id="tableHead" class="bg-zinc-900 sticky top-0"></thead>
                        <tbody id="tableBody" class="divide-y divide-zinc-800"></tbody>
                    </table>
                </div>
            </div>

            <!-- JSON -->
            <div id="viewJson" class="card rounded-3xl p-8 hidden border border-zinc-800/50">
                <div class="flex justify-between mb-4 items-center">
                    <span class="uppercase text-xs tracking-widest text-zinc-500">Resposta completa</span>
                    <button id="btnCopyJson" 
                            class="flex items-center gap-2 px-5 py-2.5 bg-zinc-800 hover:bg-zinc-700 rounded-2xl text-sm transition-all">
                        <i data-lucide="copy" class="w-4 h-4"></i>
                        Copiar JSON
                    </button>
                </div>
                <pre id="jsonBlock" class="bg-black/60 p-8 rounded-2xl text-emerald-300 text-xs overflow-auto max-h-[520px] font-mono leading-relaxed border border-zinc-800"></pre>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let chartInstance = null;
        let currentData = null;

        const state = {
            ticker: 'GARE11',
            assetType: 'fii',
            endpoint: 'getpatrimonioliquido',
            dataType: '0',
            rangeMin: '2020',
            rangeMax: new Date().getFullYear().toString()
        };

        const endpoints = [
            { id: 'getpatrimonioliquido', name: 'Património Líquido', param: 'code' },
            { id: 'getreceitas', name: 'Receitas', param: 'code' },
            { id: 'getdespesas', name: 'Despesas', param: 'code' },
            { id: 'getcaixa', name: 'Caixa', param: 'code' },
            { id: 'getresultado', name: 'Resultado', param: 'code' },
            { id: 'demonstracoestrimestrais', name: 'Demonstrações Trimestrais', param: 'code', requiresRange: true },
            { id: 'companytickerprovents', name: 'Proventos / Dividendos', param: 'companyName', extra: '&chartProventsType=1' }
        ];

        // Populate endpoint select
        const endpointEl = document.getElementById('endpoint');
        endpoints.forEach(ep => {
            const opt = document.createElement('option');
            opt.value = ep.id;
            opt.textContent = ep.name;
            endpointEl.appendChild(opt);
        });
        document.getElementById('rangeMax').value = state.rangeMax;

        // Update UI
        function updateUI() {
            const ep = endpoints.find(e => e.id === state.endpoint);
            document.getElementById('rangeOptions').classList.toggle('hidden', !ep.requiresRange);
            document.getElementById('dataType').disabled = (ep.id === 'companytickerprovents');
        }

        ['ticker','assetType','endpoint','dataType','rangeMin','rangeMax'].forEach(id => {
            document.getElementById(id).addEventListener('change', e => {
                state[id] = (id === 'ticker') ? e.target.value.toUpperCase() : e.target.value;
                updateUI();
            });
        });

        // Tabs
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
            document.getElementById(`tab${tab}`).classList.add('tab-active');
            
            ['Chart','Table','Json'].forEach(t => {
                document.getElementById(`view${t}`).classList.toggle('hidden', t.toLowerCase() !== tab.toLowerCase());
            });
        }

        document.getElementById('tabChart').addEventListener('click', () => switchTab('Chart'));
        document.getElementById('tabTable').addEventListener('click', () => switchTab('Table'));
        document.getElementById('tabJson').addEventListener('click', () => switchTab('Json'));

        // Format helper
        function formatCell(val, key) {
            if (val === null || val === undefined) return '—';
            
            const k = key.toLowerCase();
            
            if (typeof val === 'number') {
                if (k.includes('dy') || k.includes('yield') || k.includes('percent') || k.includes('taxa')) {
                    return val.toFixed(2) + '%';
                }
                if (Math.abs(val) > 999 || k.includes('valor') || k.includes('patrim') || k.includes('receit') || k.includes('caixa') || k.includes('result')) {
                    return 'R$ ' + val.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                }
                return val.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            }
            
            if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}/.test(val)) {
                return new Intl.DateTimeFormat('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' }).format(new Date(val));
            }
            
            return val;
        }

        // Smart multi-series chart
        function renderChart(dataArray) {
            if (chartInstance) chartInstance.destroy();

            const keys = Object.keys(dataArray[0] || {});
            const dateCandidates = keys.filter(k => /date|ed|competence|payment|ano|trimestre/i.test(k));
            const xKey = dateCandidates[0] || keys[0];

            // Numeric series (max 5)
            const numericKeys = keys.filter(k => {
                if (k === xKey) return false;
                const sample = dataArray[0][k];
                return typeof sample === 'number' || 
                       (typeof sample === 'string' && !isNaN(parseFloat(sample)));
            }).slice(0, 5);

            if (numericKeys.length === 0) {
                document.getElementById('viewChart').innerHTML = `
                    <div class="flex flex-col items-center justify-center h-96 text-zinc-500">
                        <i data-lucide="bar-chart-3" class="w-20 h-20 mb-6 opacity-30"></i>
                        <p class="text-lg">Sem dados numéricos para gráfico</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            // Sort chronologically if dates
            if (dateCandidates.length) {
                dataArray.sort((a,b) => new Date(a[xKey]) - new Date(b[xKey]));
            }

            const labels = dataArray.map(item => {
                let v = item[xKey];
                if (typeof v === 'string' && /^\d{4}-\d{2}-\d{2}/.test(v)) {
                    return new Intl.DateTimeFormat('pt-BR', {month:'short', year:'2-digit'}).format(new Date(v));
                }
                return v;
            });

            const colorPalette = ['#a5b4fc', '#67e8f9', '#c4d0ff', '#f472b6', '#fb923c'];

            const datasets = numericKeys.map((key, i) => ({
                label: key.replace(/([A-Z])/g, ' $1').trim().toUpperCase(),
                data: dataArray.map(item => {
                    let v = item[key];
                    return typeof v === 'string' ? parseFloat(v) || 0 : (v || 0);
                }),
                borderColor: colorPalette[i],
                backgroundColor: colorPalette[i] + '22',
                borderWidth: 3.5,
                tension: 0.35,
                pointRadius: 0,
                pointHoverRadius: 6
            }));

            const ctx = document.getElementById('myChart').getContext('2d');
            
            chartInstance = new Chart(ctx, {
                type: dateCandidates.length ? 'line' : 'bar',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: { color: '#d1d5db', padding: 20, usePointStyle: true }
                        },
                        tooltip: {
                            backgroundColor: '#18181b',
                            borderColor: '#3f3f46',
                            borderWidth: 1,
                            titleColor: '#71717a',
                            bodyColor: '#e4e4e7',
                            callbacks: {
                                label: (ctx) => {
                                    const lbl = ctx.dataset.label.toLowerCase();
                                    let val = ctx.raw;
                                    if (lbl.includes('dy') || lbl.includes('yield')) return val.toFixed(2) + '%';
                                    if (Math.abs(val) > 1000) return 'R$ ' + val.toLocaleString('pt-BR', {minimumFractionDigits:2});
                                    return val.toLocaleString('pt-BR');
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { color: '#27272a' }, ticks: { color: '#71717a' } },
                        y: { grid: { color: '#27272a' }, ticks: { color: '#71717a' } }
                    }
                }
            });
        }

        // Table render
        function renderTable(dataArray) {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            const keys = Object.keys(dataArray[0] || {});

            // Header
            const headRow = document.createElement('tr');
            keys.forEach(key => {
                const th = document.createElement('th');
                th.className = 'px-8 py-5 text-left text-xs font-medium text-zinc-400 uppercase tracking-widest';
                th.textContent = key.replace(/([A-Z])/g, ' $1').trim();
                headRow.appendChild(th);
            });
            thead.appendChild(headRow);

            // Rows
            dataArray.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'data-row';
                keys.forEach(key => {
                    const td = document.createElement('td');
                    td.className = 'px-8 py-5 whitespace-nowrap';
                    const formatted = formatCell(item[key], key);
                    td.textContent = formatted;
                    if (typeof item[key] === 'number') td.classList.add('font-mono', 'text-emerald-300');
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });
        }

        // Main process
        function processData(raw) {
            currentData = raw;

            // Find main data array
            let dataArray = [];
            if (Array.isArray(raw)) dataArray = raw;
            else {
                const arrKey = Object.keys(raw).find(k => Array.isArray(raw[k]));
                dataArray = arrKey ? raw[arrKey] : [];
            }

            if (dataArray.length === 0) {
                document.getElementById('viewChart').innerHTML = `<p class="text-center py-32 text-zinc-500">Nenhum dado tabular encontrado. Veja o JSON.</p>`;
                document.getElementById('tableBody').innerHTML = `<tr><td colspan="10" class="text-center py-20 text-zinc-500">Sem dados</td></tr>`;
                return;
            }

            // Render everything
            renderTable(dataArray);
            renderChart(dataArray);
        }

        // Extract
        document.getElementById('btnExtract').addEventListener('click', async () => {
            const btn = document.getElementById('btnExtract');
            const err = document.getElementById('errorMsg');
            const container = document.getElementById('dataContainer');

            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-6 h-6 animate-spin"></i> A obter dados...`;
            err.classList.add('hidden');
            lucide.createIcons();

            const ep = endpoints.find(e => e.id === state.endpoint);
            
            let url = `https://statusinvest.com.br/${state.assetType}/${ep.id}?${ep.param}=${state.ticker}`;
            if (ep.id !== 'companytickerprovents') url += `&type=${state.dataType}`;
            if (ep.requiresRange) {
                url += `&contabil=true&range.min=${state.rangeMin}&range.max=${state.rangeMax}`;
            }
            if (ep.extra) url += ep.extra;

            const proxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;

            try {
                const res = await fetch(proxy);
                if (!res.ok) throw new Error();
                
                const json = await res.json();
                document.getElementById('jsonBlock').textContent = JSON.stringify(json, null, 2);
                
                processData(json);
                container.classList.remove('hidden');
                switchTab('Chart');
                
            } catch (e) {
                err.textContent = 'Erro ao conectar com o StatusInvest. Verifique o ticker ou tente novamente.';
                err.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="download-cloud" class="w-6 h-6"></i> EXTRAIR E VISUALIZAR`;
                lucide.createIcons();
            }
        });

        // Copy JSON
        document.getElementById('btnCopyJson').addEventListener('click', async () => {
            const text = document.getElementById('jsonBlock').textContent;
            await navigator.clipboard.writeText(text);
            const orig = this.innerHTML;
            this.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Copiado!`;
            this.style.color = '#4ade80';
            setTimeout(() => {
                this.innerHTML = orig;
                this.style.color = '';
            }, 1800);
        });

        // Init
        updateUI();
        document.getElementById('rangeOptions').classList.add('hidden'); // initial
    </script>
</body>
</html>
